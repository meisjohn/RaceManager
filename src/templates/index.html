{% extends "base.html" %}
{% block content %}
    <section class="section">
        <div class="container">
            <h1 class="title">Racers</h1>

            {% if error %}
                <p class="notification is-danger">{{ error }}</p>
            {% endif %}

            {% if archived: %}
                {% set disabled='disabled' %}
            {% else %}
                {% set disabled='' %}
            {% endif %}

            {% if session['role'] == 'OWNER' or session['role'] == 'ADMIN' %}
                <h2 class="subtitle">Add Racer</h2>

                <form method="POST" action="{{ url_for('add_participant') }}">
                    <div class="field">
                        <label class="label">First Name</label>
                        <div class="control">
                            <input class="input" type="text" name="first_name" autofocus required {{disabled}}>
                        </div>
                    </div>

                    <div class="field">
                        <label class="label">Last Name</label>
                        <div class="control">
                            <input class="input" type="text" name="last_name" required {{disabled}}>
                        </div>
                    </div>

                    <div class="field">
                        <label class="label">Patrol</label>
                        <div class="control">
                            <div class="select">
                                <select name="patrol" required {{disabled}}>
                                    {% for id, name in patrol_names.items()|sort %}
                                        <option value="{{ id }}">{{ name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="field">
                        <div class="control">
                            <input class="button is-primary" type="submit" value="Add" {{disabled}}>
                        </div>
                    </div>
                </form>

                <a href="{{ url_for('upload_roster') }}" class="button is-info {{disabled}}">Bulk Upload</a>

                <h2 class="subtitle">Racer List</h2>
            {% endif %}

            {% for patrol_id, items in participants|groupby('patrol') %}
                <details class="patrol-section" open>
                    <summary class="is-size-5">
                        {{ patrol_names.get(patrol_id, patrol_id) }}
                        <span class="tag is-rounded">{{ items|length }}</span>
                    </summary>
                    <div class="content-wrapper">
                        <div class="columns is-multiline">
                            {% for p in items %}
                                <div class="column is-12-mobile is-6-tablet is-5-desktop">
                                    <div class="card" style="height: 100%; display: flex; flex-direction: column;">
                                        <div class="card-header has-background-info-light">
                                            <p class="card-header-title title is-4">{{ p.first_name }} {{ p.last_name }}</p>
                                        </div>
                                        <div class="card-content">
                                            <div class="media">
                                                <div class="media-content">
                                                    <p class="subtitle is-5">Car: <strong>{{ p.car_name }}</strong>
                                                    {% if p.car_weight_oz %}
                                                    | Weight: <strong>{{ p.car_weight_oz }} oz</strong>
                                                    {% endif %}
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                        <footer class="card-footer" style="margin-top: auto;">
                                            <a href="/participant_times/{{ p.participant_id }}" class="card-footer-item button is-info {{disabled}}">Times</a>
                                            {% if session['role'] == 'OWNER' or session['role'] == 'ADMIN' %}
                                                <a href="/edit_participant/{{ p.participant_id }}" class="card-footer-item button is-link {{disabled}}">Edit</a>
                                                <form method="POST" action="/delete_participant/{{ p.participant_id }}" class="card-footer-item p-0" style="align-items: stretch;">
                                                    <button class="button is-danger is-inverted is-fullwidth" type="submit" onclick="return confirm('Are you sure you want to delete this participant?')" {{disabled}}>Delete</button>
                                                </form>
                                            {% endif %}
                                        </footer>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </details>
            {% else %}
                <div class="notification is-info">No participants found.</div>
            {% endfor %}

            <br>
            {% if session['role'] == 'OWNER' or session['role'] == 'ADMIN' %}
                <div class="has-text-centered">
                    <a href="javascript:confirmAction('Are you sure you want to clear existing race data and schedule new races?', '{{url_for('schedule_initial', schedule_type=RaceScheduleType.PAIRED.value)}}')" class="button is-large is-warning {{disabled}}">Clear Race Data and Schedule Paired Lanes for First Round</a>
                    <a href="javascript:confirmAction('Are you sure you want to clear existing race data and schedule new races?', '{{url_for('schedule_initial', schedule_type=RaceScheduleType.ALL_LANES.value)}}')" class="button is-large is-warning {{disabled}}">Clear Race Data and Schedule All Lanes First Round</a>

                </div>
            {% endif %}
        </div>
    </section>
{% endblock %}